# Regras do Firestore - M√≥dulo Financeiro

Este documento cont√©m as regras de seguran√ßa do Firestore para o m√≥dulo financeiro da aplica√ß√£o.

## üìã Collections do M√≥dulo Financeiro

### 1. `contas_pagar`
Armazena todas as despesas da cl√≠nica.

**Estrutura:**
```javascript
{
  clinicaId: string,           // ID da cl√≠nica (para multi-tenancy)
  descricao: string,           // Descri√ß√£o da despesa
  categoria: string,           // aluguel, salarios, fornecedores, etc.
  fornecedor: string,          // Nome do fornecedor (opcional)
  valor: number,               // Valor da despesa
  dataVencimento: timestamp,   // Data de vencimento
  status: string,              // pendente, pago, vencido
  dataPagamento: timestamp,    // Data do pagamento (se pago)
  valorPago: number,           // Valor efetivamente pago (se diferente)
  observacoes: string,         // Observa√ß√µes adicionais
  dataCriacao: timestamp       // Data de cria√ß√£o do registro
}
```

### 2. `contas_receber`
Armazena todas as receitas da cl√≠nica.

**Estrutura:**
```javascript
{
  clinicaId: string,           // ID da cl√≠nica (para multi-tenancy)
  descricao: string,           // Descri√ß√£o da receita
  categoria: string,           // consultas, procedimentos, produtos, etc.
  cliente: string,             // Nome do cliente (opcional)
  valor: number,               // Valor da receita
  dataVencimento: timestamp,   // Data de vencimento
  status: string,              // pendente, recebido, vencido
  dataRecebimento: timestamp,  // Data do recebimento (se recebido)
  valorRecebido: number,       // Valor efetivamente recebido (se diferente)
  observacoes: string,         // Observa√ß√µes adicionais
  dataCriacao: timestamp       // Data de cria√ß√£o do registro
}
```

### 3. `movimentacoes`
Armazena o fluxo de caixa (movimenta√ß√µes di√°rias).

**Estrutura:**
```javascript
{
  clinicaId: string,           // ID da cl√≠nica (para multi-tenancy)
  tipo: string,                // entrada ou saida
  descricao: string,           // Descri√ß√£o da movimenta√ß√£o
  categoria: string,           // Categoria (mesmas das contas)
  valor: number,               // Valor da movimenta√ß√£o
  data: timestamp,             // Data da movimenta√ß√£o
  contaId: string,             // ID da conta relacionada (opcional)
  tipoConta: string,           // pagar ou receber (se relacionado a conta)
  observacoes: string,         // Observa√ß√µes adicionais
  dataCriacao: timestamp       // Data de cria√ß√£o do registro
}
```

## üîí Regras de Seguran√ßa do Firestore

### Regras para Desenvolvimento

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regras para contas_pagar
    match /contas_pagar/{contaId} {
      // Permitir leitura para todos (tempor√°rio para desenvolvimento)
      allow read: if true;
      
      // Permitir escrita para todos (tempor√°rio para desenvolvimento)
      allow create, update, delete: if true;
    }
    
    // Regras para contas_receber
    match /contas_receber/{contaId} {
      // Permitir leitura para todos (tempor√°rio para desenvolvimento)
      allow read: if true;
      
      // Permitir escrita para todos (tempor√°rio para desenvolvimento)
      allow create, update, delete: if true;
    }
    
    // Regras para movimentacoes
    match /movimentacoes/{movimentacaoId} {
      // Permitir leitura para todos (tempor√°rio para desenvolvimento)
      allow read: if true;
      
      // Permitir escrita para todos (tempor√°rio para desenvolvimento)
      allow create, update, delete: if true;
    }
  }
}
```

### Regras para Produ√ß√£o

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fun√ß√£o auxiliar para verificar autentica√ß√£o
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Fun√ß√£o auxiliar para verificar se o usu√°rio pertence √† cl√≠nica
    function belongsToClinic(clinicaId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/configuracoes/$(clinicaId)).data.userId == request.auth.uid;
    }
    
    // Regras para contas_pagar
    match /contas_pagar/{contaId} {
      // Permitir leitura apenas para membros da cl√≠nica
      allow read: if isSignedIn() && 
                     belongsToClinic(resource.data.clinicaId);
      
      // Permitir cria√ß√£o apenas se autenticado e pertencer √† cl√≠nica
      allow create: if isSignedIn() && 
                       belongsToClinic(request.resource.data.clinicaId) &&
                       request.resource.data.clinicaId is string &&
                       request.resource.data.descricao is string &&
                       request.resource.data.categoria is string &&
                       request.resource.data.valor is number &&
                       request.resource.data.dataVencimento is timestamp &&
                       request.resource.data.status in ['pendente', 'pago', 'vencido'];
      
      // Permitir atualiza√ß√£o apenas se autenticado e pertencer √† cl√≠nica
      allow update: if isSignedIn() && 
                       belongsToClinic(resource.data.clinicaId) &&
                       request.resource.data.clinicaId == resource.data.clinicaId;
      
      // Permitir exclus√£o apenas se autenticado e pertencer √† cl√≠nica
      allow delete: if isSignedIn() && 
                       belongsToClinic(resource.data.clinicaId);
    }
    
    // Regras para contas_receber
    match /contas_receber/{contaId} {
      // Permitir leitura apenas para membros da cl√≠nica
      allow read: if isSignedIn() && 
                     belongsToClinic(resource.data.clinicaId);
      
      // Permitir cria√ß√£o apenas se autenticado e pertencer √† cl√≠nica
      allow create: if isSignedIn() && 
                       belongsToClinic(request.resource.data.clinicaId) &&
                       request.resource.data.clinicaId is string &&
                       request.resource.data.descricao is string &&
                       request.resource.data.categoria is string &&
                       request.resource.data.valor is number &&
                       request.resource.data.dataVencimento is timestamp &&
                       request.resource.data.status in ['pendente', 'recebido', 'vencido'];
      
      // Permitir atualiza√ß√£o apenas se autenticado e pertencer √† cl√≠nica
      allow update: if isSignedIn() && 
                       belongsToClinic(resource.data.clinicaId) &&
                       request.resource.data.clinicaId == resource.data.clinicaId;
      
      // Permitir exclus√£o apenas se autenticado e pertencer √† cl√≠nica
      allow delete: if isSignedIn() && 
                       belongsToClinic(resource.data.clinicaId);
    }
    
    // Regras para movimentacoes
    match /movimentacoes/{movimentacaoId} {
      // Permitir leitura apenas para membros da cl√≠nica
      allow read: if isSignedIn() && 
                     belongsToClinic(resource.data.clinicaId);
      
      // Permitir cria√ß√£o apenas se autenticado e pertencer √† cl√≠nica
      allow create: if isSignedIn() && 
                       belongsToClinic(request.resource.data.clinicaId) &&
                       request.resource.data.clinicaId is string &&
                       request.resource.data.tipo in ['entrada', 'saida'] &&
                       request.resource.data.descricao is string &&
                       request.resource.data.categoria is string &&
                       request.resource.data.valor is number &&
                       request.resource.data.data is timestamp;
      
      // Permitir atualiza√ß√£o apenas se autenticado e pertencer √† cl√≠nica
      allow update: if isSignedIn() && 
                       belongsToClinic(resource.data.clinicaId) &&
                       request.resource.data.clinicaId == resource.data.clinicaId;
      
      // Permitir exclus√£o apenas se autenticado e pertencer √† cl√≠nica
      allow delete: if isSignedIn() && 
                       belongsToClinic(resource.data.clinicaId);
    }
  }
}
```

## üìä √çndices Necess√°rios no Firestore

Para melhor performance, crie os seguintes √≠ndices compostos no Firestore Console:

### Collection: `contas_pagar`
1. **√çndice 1:**
   - Campo: `clinicaId` (Ascending)
   - Campo: `status` (Ascending)
   - Campo: `dataVencimento` (Ascending)

2. **√çndice 2:**
   - Campo: `clinicaId` (Ascending)
   - Campo: `categoria` (Ascending)
   - Campo: `dataVencimento` (Ascending)

### Collection: `contas_receber`
1. **√çndice 1:**
   - Campo: `clinicaId` (Ascending)
   - Campo: `status` (Ascending)
   - Campo: `dataVencimento` (Ascending)

2. **√çndice 2:**
   - Campo: `clinicaId` (Ascending)
   - Campo: `categoria` (Ascending)
   - Campo: `dataVencimento` (Ascending)

### Collection: `movimentacoes`
1. **√çndice 1:**
   - Campo: `clinicaId` (Ascending)
   - Campo: `data` (Descending)

2. **√çndice 2:**
   - Campo: `clinicaId` (Ascending)
   - Campo: `tipo` (Ascending)
   - Campo: `data` (Descending)

## üöÄ Como Aplicar as Regras

### Pelo Firebase Console (Recomendado)

1. Acesse o [Firebase Console](https://console.firebase.google.com/)
2. Selecione seu projeto
3. V√° em **Firestore Database** ‚Üí **Regras**
4. Cole as regras de produ√ß√£o acima
5. Clique em **Publicar**

### Pelo Firebase CLI

```bash
# Criar arquivo firestore.rules com as regras acima
# Depois executar:
firebase deploy --only firestore:rules
```

## ‚ö†Ô∏è Importante

1. **Desenvolvimento vs Produ√ß√£o:**
   - Use as regras de desenvolvimento apenas em ambiente de testes
   - Em produ√ß√£o, SEMPRE use as regras com autentica√ß√£o

2. **Multi-tenancy:**
   - Todas as consultas devem filtrar por `clinicaId`
   - Nunca confie apenas nas regras do Firestore, valide no frontend tamb√©m

3. **Performance:**
   - Crie os √≠ndices compostos conforme especificado acima
   - O Firestore pode sugerir √≠ndices automaticamente ao fazer consultas

4. **Custos:**
   - Cada leitura/escrita no Firestore tem custo
   - Otimize suas consultas para reduzir custos
   - Use cache quando apropriado

## üìù Exemplo de Uso

```javascript
import { collection, query, where, getDocs } from 'firebase/firestore'
import { db } from './firebase'

// Buscar contas a pagar de uma cl√≠nica
const buscarContasPagar = async (clinicaId) => {
  const q = query(
    collection(db, 'contas_pagar'),
    where('clinicaId', '==', clinicaId),
    where('status', '==', 'pendente')
  )
  
  const snapshot = await getDocs(q)
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }))
}
```

## üîÑ Migra√ß√£o de Dados

Se voc√™ j√° tem dados no Firestore, execute uma migra√ß√£o para adicionar o campo `clinicaId`:

```javascript
// Script de migra√ß√£o (executar uma vez)
const migrarDados = async (clinicaId) => {
  const collections = ['contas_pagar', 'contas_receber', 'movimentacoes']
  
  for (const collectionName of collections) {
    const snapshot = await getDocs(collection(db, collectionName))
    
    for (const doc of snapshot.docs) {
      if (!doc.data().clinicaId) {
        await updateDoc(doc.ref, {
          clinicaId: clinicaId
        })
      }
    }
  }
}
```

## üìö Recursos Adicionais

- [Documenta√ß√£o oficial do Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Guia de boas pr√°ticas](https://firebase.google.com/docs/firestore/security/rules-conditions)
- [Simulador de regras](https://firebase.google.com/docs/firestore/security/test-rules-emulator)

