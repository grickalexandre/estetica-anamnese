rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fun√ß√£o auxiliar para verificar autentica√ß√£o
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Fun√ß√£o para verificar se o usu√°rio pertence √† cl√≠nica
    function belongsToClinica(clinicaId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.clinicaId == clinicaId;
    }
    
    // Regras para usu√°rios
    match /usuarios/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Compatibilidade com 'users' (se necess√°rio)
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Regras para cl√≠nicas
    match /clinicas/{clinicaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if belongsToClinica(clinicaId);
    }
    
    // Regras para configura√ß√µes
    match /configuracoes/{clinicaId} {
      allow read: if true; // Permite leitura p√∫blica para p√°gina de anamnese do cliente
      allow write: if belongsToClinica(clinicaId);
    }
    
    // Regras para anamneses
    match /anamneses/{anamneseId} {
      allow read: if true; // Leitura p√∫blica para clientes acessarem
      allow create: if true; // Cria√ß√£o p√∫blica (clientes preenchendo)
      allow update: if isAuthenticated() || true; // Permite atualiza√ß√£o
      allow delete: if isAuthenticated();
    }
    
    // Regras para clientes/pacientes
    match /clientes/{clienteId} {
      allow read, write: if true; // Permite cria√ß√£o autom√°tica ao preencher anamnese
    }
    
    // Regras para profissionais
    match /profissionais/{profissionalId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.clinicaId != null;
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Regras para fornecedores
    match /fornecedores/{fornecedorId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para produtos
    match /produtos/{produtoId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para procedimentos (cat√°logo) - nomenclatura antiga
    match /procedimentos/{procedimentoId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para cat√°logo de procedimentos - nomenclatura atual
    match /catalogo_procedimentos/{procedimentoId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para atendimentos
    match /atendimentos/{atendimentoId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para agendamentos
    match /agendamentos/{agendamentoId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para contas a pagar
    match /contas_pagar/{contaId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para contas a receber
    match /contas_receber/{contaId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para comiss√µes
    match /comissoes/{comissaoId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para plano de contas
    match /plano_contas/{contaId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para movimenta√ß√µes de estoque
    match /movimentacoes_estoque/{movimentacaoId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para compras
    match /compras/{compraId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para despesas recorrentes
    match /despesas_recorrentes/{despesaId} {
      allow read, write: if isAuthenticated();
    }
    
    // Regras para observa√ß√µes de anamnese
    match /observacoes_anamnese/{observacaoId} {
      allow read, write: if isAuthenticated();
    }
    
    // üÜï Regras para pagamentos
    match /pagamentos/{pagamentoId} {
      allow read, write: if isAuthenticated();
    }
    
    // üÜï Regras para usuarios_clinica (multi-usu√°rio)
    match /usuarios_clinica/{vinculoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // üÜï Regras para auditoria (apenas leitura para usu√°rios, escrita apenas sistema)
    match /auditoria/{auditoriaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Sistema cria automaticamente
      allow update, delete: if false; // Auditoria n√£o pode ser modificada/deletada
    }
    
    // üÜï Regras para avalia√ß√µes
    match /avaliacoes/{avaliacaoId} {
      allow read: if isAuthenticated();
      allow create: if true; // Permite cria√ß√£o p√∫blica (clientes sem login via link)
      allow update: if isAuthenticated(); // Apenas cl√≠nica pode responder
      allow delete: if isAuthenticated();
    }
    
    // üì¶ Regras para planos (p√∫blico)
    match /planos/{planoId} {
      allow read: if true; // Leitura p√∫blica
      allow write: if false; // Apenas admin do sistema pode modificar
    }
    
    // üì¶ Regras para assinaturas
    match /assinaturas/{assinaturaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false; // N√£o permite deletar assinaturas, apenas cancelar
    }
    
    // Regra padr√£o: negar tudo que n√£o foi especificado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

